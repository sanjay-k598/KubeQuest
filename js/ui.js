(function(){const term=document.getElementById('terminalOut');const input=document.getElementById('cmd');const runBtn=document.getElementById('runBtn');const hintBox=document.getElementById('hint');const missionSel=document.getElementById('missionSelect');const missionTitle=document.getElementById('missionTitle');const scoreEl=document.getElementById('score');const timeEl=document.getElementById('time');const sloEl=document.getElementById('slo');let mission=null,state=null,timer=null;function log(text){const pre=document.createElement('pre');pre.className='text-xs md:text-sm';pre.textContent=text;term.appendChild(pre);term.scrollTop=term.scrollHeight}function clearTerm(){term.innerHTML=''}function renderHUD(){const w=document.getElementById('workloads');w.innerHTML='';Object.entries(state.deployments).forEach(([name,d])=>{const ready=state.pods.filter(p=>p.owner===name&&p.ready).length;const div=document.createElement('div');div.className='badge rounded p-2 bg-black/20 flex items-center justify-between';div.innerHTML=`<div class="text-sm font-medium">${name}</div><div class="text-xs text-white/70">${ready}/${d.replicas} Ready</div>`;w.appendChild(div)});const n=document.getElementById('network');n.innerHTML='';(state.services||[]).forEach(svc=>{const div=document.createElement('div');div.className='badge rounded p-2 bg-black/20';div.innerHTML=`<div class="text-sm font-medium">${svc.name}</div><div class="text-xs text-white/70">Endpoints: ${(svc.endpoints||[]).join(',')||"&lt;none&gt;"}</div>`;n.appendChild(div)});const no=document.getElementById('nodes');no.innerHTML='';(state.nodes||[]).forEach(nd=>{const div=document.createElement('div');div.className='badge rounded p-2 bg-black/20 flex items-center justify-between';div.innerHTML=`<div class="text-sm font-medium">${nd.name}</div><div class="text-xs ${nd.ready?'text-ok':'text-err'}">${nd.ready?'Ready':'NotReady'}</div>`;no.appendChild(div)});scoreEl.textContent=state._score;timeEl.textContent=state._time+'s';const total=state.pods.length||1;const ready=state.pods.filter(p=>p.ready).length;sloEl.textContent=Math.round((ready/total)*100)+'%'}function setMissionById(id){mission=(window.MISSIONS||[]).find(m=>m.id===id)||window.MISSIONS[0];state=Engine.initState(mission);missionTitle.textContent=mission.title;hintBox.textContent=mission.brief;clearTerm();log(`# ${mission.title}
${mission.brief}
Type 'help' to list supported commands.`);renderHUD();if(timer)clearInterval(timer);timer=setInterval(()=>{Engine.tick(state,1);renderHUD();checkWin()},1000)}function checkWin(){try{if(mission.win(state)){clearInterval(timer);log("\nâœ… Incident resolved. Great job!");state._score+=50;renderHUD()}}catch(e){}}runBtn.addEventListener('click',exec);input.addEventListener('keydown',(e)=>{if(e.key==='Enter')exec();if(e.ctrlKey&&e.key.toLowerCase()==='l'){e.preventDefault();clearTerm()}});function exec(){const txt=input.value.trim();if(!txt)return;log(`$ ${txt}`);const ast=CMD_PARSER.parse(txt);const res=Engine.runCmd(state,ast,mission);if(res.clear){clearTerm()}if(res.text){log(res.text)}state._score+=res.score||0;input.value='';Engine.tick(state,0);renderHUD();checkWin()}document.getElementById('hintBtn').onclick=()=>{const h=(mission.state.hints||[])[Math.min(Math.floor(state._time/5),(mission.state.hints||[]).length-1)]||"Try 'describe' or 'logs' first.";hintBox.textContent="Hint: "+h};document.getElementById('resetBtn').onclick=()=>setMissionById(mission.id);(window.MISSIONS||[]).forEach(m=>{const opt=document.createElement('option');opt.value=m.id;opt.textContent=m.title;missionSel.appendChild(opt)});missionSel.onchange=()=>setMissionById(missionSel.value);setMissionById((window.MISSIONS||[])[0]?.id)})();